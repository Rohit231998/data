import pandas as pd
import os
import glob
import re
import shutil

# Folder where files were copied
source_folder = "source_files"
file_pattern = os.path.join(source_folder, "SVI_*_US_county.csv")

# Get matching CSV files
files = glob.glob(file_pattern)

if not files:
    print("No matching files found.")
else:
    print(f"Found {len(files)} files to process.\n")

# Process each file
for file_path in files:
    filename = os.path.basename(file_path)
    print(f"Processing file: {filename}")

    # Extract year from filename
    match = re.search(r"SVI_(\d{4})_US_county\.csv", filename)
    if not match:
        print(f"Year not found in filename: {filename}")
        continue

    year = int(match.group(1))
    print(f"Extracted year: {year}")

    # Special handling for 2010
    if year == 2010:
        target_dir = os.path.join(source_folder, "2010")
        os.makedirs(target_dir, exist_ok=True)
        target_path = os.path.join(target_dir, filename)
        try:
            shutil.move(file_path, target_path)
            print(f"Moved 2010 file to: {target_path}\n")
        except Exception as e:
            print(f"Failed to move 2010 file: {e}")
        continue

    # Read CSV, add year, and overwrite
    try:
        df = pd.read_csv(file_path)
        print(f"Rows in file: {len(df)}")

        df["year"] = year

        df.to_csv(file_path, index=False)
        print(f"File overwritten with year column: {file_path}\n")

    except Exception as e:
        print(f"Failed to process file {filename}: {e}")

